// „É°„Ç§„É≥ JavaScript „Éï„Ç°„Ç§„É´

class HeuristicAnalyzer {
    constructor() {
        this.form = document.getElementById('analysisForm');
        this.analyzeBtn = document.getElementById('analyzeBtn');
        this.resultsSection = document.getElementById('results');
        this.currentAnalysisData = null;
        this.init();
    }

    init() {
        this.form.addEventListener('submit', this.handleSubmit.bind(this));
        
        // Ë©≥Á¥∞Ë°®Á§∫„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        const detailBtn = document.getElementById('showDetailedAnalysis');
        if (detailBtn) {
            detailBtn.addEventListener('click', this.loadDetailedAnalysis.bind(this));
        }
    }

    async handleSubmit(event) {
        event.preventDefault();
        
        const formData = new FormData(this.form);
        const requestData = {
            url: formData.get('url'),
            device_type: formData.get('device_type')
        };

        // UIÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
        this.setLoading(true);
        this.hideResults();

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            this.currentAnalysisData = {
                url: result.url,
                device_type: result.url.includes('device_type') ? 'mobile' : 'desktop' // Á∞°ÊòìÂÆüË£Ö
            };
            this.displayResults(result);
            
        } catch (error) {
            console.error('ÂàÜÊûê„Ç®„É©„Éº:', error);
            this.showError('ÂàÜÊûê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇURL„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
        } finally {
            this.setLoading(false);
        }
    }

    setLoading(isLoading) {
        const btnText = this.analyzeBtn.querySelector('.btn-text');
        const spinner = this.analyzeBtn.querySelector('.loading-spinner');
        
        if (isLoading) {
            btnText.textContent = 'ÂàÜÊûê‰∏≠...';
            spinner.style.display = 'inline';
            this.analyzeBtn.disabled = true;
        } else {
            btnText.textContent = 'ÂàÜÊûêÈñãÂßã';
            spinner.style.display = 'none';
            this.analyzeBtn.disabled = false;
        }
    }

    hideResults() {
        this.resultsSection.style.display = 'none';
    }

    displayResults(result) {
        // Á∑èÂêà„Çπ„Ç≥„Ç¢„ÅÆË°®Á§∫
        document.getElementById('totalScore').textContent = result.total_score;

        // „Ç´„ÉÜ„Ç¥„É™Âà•„Çπ„Ç≥„Ç¢„ÅÆË°®Á§∫„Å®„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        this.updateCategoryScores(result.categories);

        // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÅÆË°®Á§∫
        this.displayScreenshot(result.screenshot_path);

        // ÊîπÂñÑÊèêÊ°à„ÅÆË°®Á§∫
        this.displayRecommendations(result.recommendations);

        // ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
        this.resultsSection.style.display = 'block';
        
        // Ë©≥Á¥∞Ë°®Á§∫„Éú„Çø„É≥„ÇíË°®Á§∫
        const detailBtn = document.getElementById('showDetailedAnalysis');
        if (detailBtn) {
            detailBtn.style.display = 'block';
        }
        
        // ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥„Å´„Çπ„É†„Éº„Ç∫„Çπ„ÇØ„É≠„Éº„É´
        this.resultsSection.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    }

    updateCategoryScores(categories) {
        const maxScores = {
            information_architecture: 30,
            cta_visibility: 20,
            readability: 20,
            form_ux: 15,
            accessibility: 10,
            performance: 5
        };

        Object.entries(categories).forEach(([category, score]) => {
            const maxScore = maxScores[category];
            const percentage = (score / maxScore) * 100;

            // „Çπ„Ç≥„Ç¢„Éê„Éº„ÅÆÊõ¥Êñ∞
            const scoreFill = document.querySelector(`[data-category="${category}"]`);
            if (scoreFill) {
                setTimeout(() => {
                    scoreFill.style.width = `${percentage}%`;
                }, 100);
            }

            // „Çπ„Ç≥„Ç¢„ÉÜ„Ç≠„Çπ„Éà„ÅÆÊõ¥Êñ∞
            const scoreText = document.querySelector(`[data-score="${category}"]`);
            if (scoreText) {
                scoreText.textContent = `${score}/${maxScore}`;
            }

            // „Çπ„Ç≥„Ç¢„Å´Âü∫„Å•„ÅÑ„Å¶Ëâ≤„ÇíÂ§âÊõ¥
            this.updateScoreColor(scoreFill, percentage);
        });
    }

    updateScoreColor(element, percentage) {
        if (!element) return;

        if (percentage >= 80) {
            element.style.background = 'linear-gradient(90deg, #48bb78, #38a169)'; // Á∑ë
        } else if (percentage >= 60) {
            element.style.background = 'linear-gradient(90deg, #ed8936, #dd6b20)'; // „Ç™„É¨„É≥„Ç∏
        } else {
            element.style.background = 'linear-gradient(90deg, #f56565, #e53e3e)'; // Ëµ§
        }
    }

    displayScreenshot(screenshotPath) {
        const screenshot = document.getElementById('screenshot');
        if (screenshotPath && screenshotPath !== '/static/screenshots/temp.png') {
            screenshot.src = screenshotPath;
            screenshot.style.display = 'block';
        }
    }

    displayRecommendations(recommendations) {
        const recommendationsList = document.getElementById('recommendationsList');
        recommendationsList.innerHTML = '';

        recommendations.forEach(recommendation => {
            const li = document.createElement('li');
            li.textContent = recommendation;
            recommendationsList.appendChild(li);
        });
    }

    showError(message) {
        // „Ç®„É©„ÉºË°®Á§∫„ÅÆÂÆüË£Ö
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.style.cssText = `
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #feb2b2;
        `;
        errorDiv.textContent = message;

        // „Éï„Ç©„Éº„É†„ÅÆÂæå„Å´„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        this.form.parentNode.insertBefore(errorDiv, this.form.nextSibling);

        // 5ÁßíÂæå„Å´„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }

    async loadDetailedAnalysis() {
        if (!this.currentAnalysisData) {
            this.showError('Ë©≥Á¥∞ÂàÜÊûê„Éá„Éº„Çø„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
            return;
        }

        const detailBtn = document.getElementById('showDetailedAnalysis');
        detailBtn.textContent = 'üìä Ë©≥Á¥∞ÂàÜÊûê„ÇíË™≠„ÅøËæº„Åø‰∏≠...';
        detailBtn.disabled = true;

        try {
            const response = await fetch('/api/analyze-detailed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(this.currentAnalysisData)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const detailedResult = await response.json();
            this.displayDetailedAnalysis(detailedResult);
            
            // „Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶Ë©≥Á¥∞„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
            detailBtn.style.display = 'none';
            document.getElementById('detailedAnalysisSection').style.display = 'block';
            
        } catch (error) {
            console.error('Ë©≥Á¥∞ÂàÜÊûê„Ç®„É©„Éº:', error);
            this.showError('Ë©≥Á¥∞ÂàÜÊûê„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            detailBtn.textContent = 'üìä Ë©≥Á¥∞„Å™ÂæóÁÇπÂÜÖË®≥„ÇíË¶ã„Çã';
            detailBtn.disabled = false;
        }
    }

    displayDetailedAnalysis(result) {
        const categoryDetails = document.getElementById('categoryDetails');
        const categoryNames = {
            'information_architecture': 'ÊÉÖÂ†±Ë®≠Ë®à',
            'cta_visibility': 'CTAË¶ñË™çÊÄß',
            'readability': 'ÂèØË™≠ÊÄß',
            'form_ux': '„Éï„Ç©„Éº„É†UX',
            'accessibility': '„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£',
            'performance': '„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ'
        };

        const maxScores = {
            'information_architecture': 30,
            'cta_visibility': 20,
            'readability': 20,
            'form_ux': 15,
            'accessibility': 10,
            'performance': 5
        };

        let detailHTML = '';

        Object.entries(result.category_details || {}).forEach(([categoryKey, details]) => {
            const categoryName = categoryNames[categoryKey] || categoryKey;
            const maxScore = maxScores[categoryKey] || 0;
            const currentScore = details.score || 0;
            const rules = details.rules || [];

            detailHTML += `
                <div class="category-detail-card">
                    <div class="category-header">
                        <h4>${categoryName}</h4>
                        <span class="category-score">${currentScore}/${maxScore}ÁÇπ</span>
                    </div>
                    
                    <div class="rules-list">
                        ${rules.length > 0 ? 
                            rules.map(rule => `
                                <div class="rule-item ${rule.passed ? 'rule-passed' : 'rule-failed'}">
                                    <div class="rule-icon">${rule.passed ? '‚úÖ' : '‚ùå'}</div>
                                    <div class="rule-content">
                                        <div class="rule-description">${rule.description}</div>
                                        <div class="rule-impact">${rule.score_impact > 0 ? '+' : ''}${rule.score_impact}ÁÇπ</div>
                                        ${!rule.passed ? `<div class="rule-recommendation">üí° ${rule.recommendation}</div>` : ''}
                                    </div>
                                </div>
                            `).join('') 
                            : '<div class="no-rules">„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅÆË©≥Á¥∞„É´„Éº„É´„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>'
                        }
                    </div>
                </div>
            `;
        });

        categoryDetails.innerHTML = detailHTML;
    }
}

// DOM„ÅåË™≠„ÅøËæº„Åæ„Çå„ÅüÂæå„Å´ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', () => {
    new HeuristicAnalyzer();
});

// „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆ„Çπ„É†„Éº„Ç∫„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®CSSËøΩÂä†
const style = document.createElement('style');
style.textContent = `
    .error-message {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
`;
document.head.appendChild(style);